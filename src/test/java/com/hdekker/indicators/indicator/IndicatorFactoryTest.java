package com.hdekker.indicators.indicator;

import static com.hdekker.indicators.indicator.IndicatoryFactory.AppliedIndicators.*;
import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.Matchers.*;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;
import java.util.Optional;
import java.util.function.Function;
import java.util.stream.Collectors;

import org.hamcrest.Matchers;
import org.junit.jupiter.api.Test;
import org.slf4j.LoggerFactory;

import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.hdekker.indicators.indicator.alert.IndicatorEvent;
import com.hdekker.indicators.indicator.alert.Threshold;
import com.hdekker.indicators.indicator.state.impl.IndicatorInternalState;
import com.hdekker.indicators.indicator.transform.RSI;

import reactor.util.function.Tuple2;
import reactor.util.function.Tuples;

/**
 * observed correct values. TODO assertions for calc at specific times.
 * @author HDekker
 *
 */
public class IndicatorFactoryTest {

	@Test
	public void canGetStaticConfiguredIndicators() {
		
		Indicator rsi14movesBelow30 = IndicatoryFactory.getIndicator("RSI-14-ThreshBelow30");
		assertThat(rsi14movesBelow30, Matchers.notNullValue());
	}

	String prices = "{\"prices\":[[1579219200000,8720.91950137424],[1579305600000,8902.568995225329],[1579392000000,8906.902675151074],[1579478400000,8690.380569544623],[1579564800000,8631.253954333763],[1579651200000,8724.818622931474],[1579737600000,8665.436914096897],[1579824000000,8415.956027335538],[1579910400000,8432.096675789418],[1579996800000,8348.665665079325],[1580083200000,8595.728298493115],[1580169600000,8879.335548714553],[1580256000000,9320.805853868467],[1580342400000,9276.893821086494],[1580428800000,9509.80513557522],[1580515200000,9308.060285564778],[1580601600000,9363.22420680057],[1580688000000,9338.416631939404],[1580774400000,9308.91270229121],[1580860800000,9179.95928107711],[1580947200000,9592.18387389791],[1581033600000,9744.636578159387],[1581120000000,9799.448455824684],[1581206400000,9890.701658194865],[1581292800000,10148.379719131783],[1581379200000,9890.121224019967],[1581465600000,10226.925769215322],[1581552000000,10328.897565836414],[1581638400000,10221.260309201634],[1581724800000,10320.157140513991],[1581811200000,9894.136123789158],[1581897600000,9943.673602578743],[1581984000000,9723.605026422496],[1582070400000,10133.817417084678],[1582156800000,9618.409248250406],[1582243200000,9608.16918128246],[1582329600000,9673.011800270346],[1582416000000,9658.606058375473],[1582502400000,9946.716123467522],[1582588800000,9670.9608064677],[1582675200000,9345.342701734848],[1582761600000,8801.657129472504],[1582848000000,8781.175282202359],[1582934400000,8717.331431359424],[1583020800000,8552.989118581636],[1583107200000,8567.802248679225],[1583193600000,8905.876104262194],[1583280000000,8756.718576742549],[1583366400000,8758.646993191916],[1583452800000,9038.870323233425],[1583539200000,9135.84506603321],[1583625600000,8902.20195010789],[1583712000000,8041.365538071835],[1583798400000,7921.33200691072],[1583884800000,7906.731528510632],[1583971200000,7935.522040170545],[1584057600000,5142.990459018316],[1584144000000,5542.819542373153],[1584230400000,5214.189112383918],[1584316800000,5397.93335743919],[1584403200000,5032.501351487721],[1584489600000,5389.41577503409],[1584576000000,5376.280747845438],[1584662400000,6170.200600237675],[1584748800000,6195.603505257629],[1584835200000,6145.770891252399],[1584921600000,5859.647430299388],[1585008000000,6456.347485963419],[1585094400000,6730.173782371188],[1585180800000,6695.9006183977235],[1585267200000,6765.56207892991],[1585353600000,6397.826328325604],[1585440000000,6255.000398693634],[1585526400000,5915.337154791903],[1585612800000,6403.141235565223],[1585699200000,6421.70541388854],[1585785600000,6640.797666310131],[1585872000000,6807.897017890566],[1585958400000,6732.852018394612],[1586044800000,6859.424923721944],[1586131200000,6788.048272605917],[1586217600000,7297.635558289496],[1586304000000,7196.782202442051],[1586390400000,7342.291601148024],[1586476800000,7294.488875121554],[1586563200000,6864.694257006497],[1586649600000,6878.781212589853],[1586736000000,6913.158787469097],[1586822400000,6857.538537511484],[1586908800000,6860.17853570111],[1586995200000,6629.431738031291],[1587081600000,7059.92622475854],[1587168000000,7035.261503989225],[1587254400000,7242.5109294929825],[1587340800000,7127.511949689152],[1587427200000,6856.456278354705],[1587513600000,6842.038597634602],[1587600000000,7109.995291181778],[1587686400000,7382.793144116689],[1587772800000,7495.393587498606],[1587859200000,7538.557687279841],[1587945600000,7683.867415083342],[1588032000000,7774.281554448049],[1588118400000,7758.230255185947],[1588204800000,8744.430287016561],[1588291200000,8610.63580374089],[1588377600000,8824.818413551968],[1588464000000,8966.307014689282],[1588550400000,8888.671912686868],[1588636800000,8884.407813577056],[1588723200000,9003.240557621584],[1588809600000,9144.68703972007],[1588896000000,9959.166416261767],[1588982400000,9821.81131529702],[1589068800000,9566.777187205966],[1589155200000,8752.617087745832],[1589241600000,8604.75159101983],[1589328000000,8788.466749414652],[1589414400000,9283.08601265873],[1589500800000,9796.494527024528],[1589587200000,9309.29535940684],[1589673600000,9375.29710843331],[1589760000000,9666.32719340344],[1589846400000,9708.439858793108],[1589932800000,9760.198937162193],[1590019200000,9526.50759300584],[1590105600000,9059.962506871727],[1590192000000,9131.767275081993],[1590278400000,9170.361063506127],[1590364800000,8731.848525870651],[1590451200000,8883.691769863415],[1590537600000,8839.130663273247],[1590624000000,9174.118563996424],[1590710400000,9546.04563503715],[1590796800000,9427.120373393418],[1590883200000,9662.70587254818],[1590969600000,9466.961781429516],[1591056000000,10167.93069332851],[1591142400000,9515.243858655718],[1591228800000,9645.227869360308],[1591315200000,9776.20299178848],[1591401600000,9636.965527050057],[1591488000000,9662.858709002241],[1591574400000,9738.603356828593],[1591660800000,9773.02951309516],[1591747200000,9767.00531665552],[1591833600000,9874.898681832236],[1591920000000,9325.996856202635],[1592006400000,9469.533297509908],[1592092800000,9469.473456163696],[1592179200000,9345.960907722063],[1592265600000,9431.719262201745],[1592352000000,9524.92661691022],[1592438400000,9463.361414311787],[1592524800000,9399.767217129216],[1592611200000,9312.780104497786],[1592697600000,9360.247968201687],[1592784000000,9298.360829121417],[1592870400000,9678.683208975835],[1592956800000,9624.684291831398],[1593043200000,9288.061774486938],[1593129600000,9258.667161007706],[1593216000000,9166.486360416233],[1593302400000,9013.90556467614],[1593388800000,9139.903276297824],[1593475200000,9185.166540651147],[1593561600000,9149.721996758017],[1593648000000,9230.672998590804],[1593734400000,9094.318072166905],[1593820800000,9071.3850427828],[1593907200000,9132.908369533492],[1593993600000,9087.407312582163],[1594080000000,9342.376492626678],[1594166400000,9253.630980242333],[1594252800000,9432.172515827939],[1594339200000,9235.716302064242],[1594425600000,9282.913638839902],[1594512000000,9234.314674712627],[1594598400000,9297.479635872663],[1594684800000,9240.76251972468],[1594771200000,9247.060695963813],[1594857600000,9203.371435179699],[1594944000000,9136.483376363976],[1595030400000,9156.276583115488],[1595116800000,9168.402736564132],[1595203200000,9202.615839500108],[1595289600000,9163.159654576915],[1595376000000,9384.379751903267],[1595462400000,9514.304987626969],[1595548800000,9589.81771944117],[1595635200000,9535.93879573746],[1595721600000,9691.825138917147],[1595808000000,9925.751397476346],[1595894400000,10962.258481207355],[1595980800000,10904.916526918994],[1596067200000,11093.612240442404],[1596153600000,11116.307163685275],[1596240000000,11325.5515272739],[1596326400000,11812.094307268515],[1596412800000,11066.306240590267],[1596499200000,11230.907762749297],[1596585600000,11181.917508034885],[1596672000000,11719.26352395155],[1596758400000,11768.127742240009],[1596844800000,11571.487980683192],[1596931200000,11739.131006414418],[1597017600000,11682.851469154939],[1597104000000,11862.938012702563],[1597190400000,11398.671060896633],[1597276800000,11579.867951602135],[1597363200000,11817.164038803397],[1597449600000,11777.391322489924],[1597536000000,11864.905810156475],[1597622400000,11901.776488302461],[1597708800000,12272.465808160425],[1597795200000,11949.610970628193],[1597881600000,11733.278970862082],[1597968000000,11861.83657727968],[1598054400000,11515.124298729217],[1598140800000,11676.385305081287],[1598227200000,11647.928120934363],[1598313600000,11758.828120368864],[1598400000000,11350.753473213],[1598486400000,11465.002564032086],[1598572800000,11300.398363810944],[1598659200000,11519.118388160729],[1598745600000,11481.481823317012],[1598832000000,11701.004008657852],[1598918400000,11672.324104943627],[1599004800000,11895.225345345636],[1599091200000,11418.254756916149],[1599177600000,10197.459822768922],[1599264000000,10484.470392265588],[1599350400000,10177.789718049991],[1599436800000,10260.0177277544],[1599523200000,10359.445216989981],[1599609600000,10125.014956069688],[1599696000000,10230.154699360752],[1599782400000,10342.159391205681],[1599868800000,10378.223044584596],[1599955200000,10439.38467226404],[1600041600000,10328.866065987393],[1600128000000,10661.096235144483],[1600214400000,10787.58020807624],[1600300800000,10952.249969107099],[1600387200000,10937.996396960929],[1600473600000,10927.150310293275],[1600560000000,11083.99836119821],[1600646400000,10923.32666818137],[1600732800000,10439.522488792423],[1600819200000,10527.58784673943],[1600905600000,10223.784106392732],[1600992000000,10726.530083321983],[1601078400000,10681.993848113701],[1601164800000,10743.19287975935],[1601251200000,10765.300521660893],[1601337600000,10672.02854425897],[1601424000000,10837.516586513004],[1601510400000,10770.881347466415],[1601596800000,10627.976063963179],[1601683200000,10572.674843011133],[1601769600000,10546.65625537982],[1601856000000,10670.700811335208],[1601942400000,10784.94940309411],[1602028800000,10605.95779130622],[1602115200000,10668.011010796896],[1602201600000,10888.666546835811],[1602288000000,11063.2523862591],[1602374400000,11286.541942043945],[1602460800000,11377.814876756858],[1602547200000,11543.183760771468],[1602633600000,11426.105544220427],[1602720000000,11435.57243757972],[1602806400000,11495.584995733887],[1602892800000,11319.097785677623],[1602979200000,11365.814131026178],[1603065600000,11495.899975689872],[1603152000000,11752.146863919786],[1603238400000,11908.708923246453],[1603324800000,12806.435726727443],[1603411200000,12951.044060038126],[1603497600000,12928.072296348406],[1603584000000,13106.04601925958],[1603670400000,13021.410842124118],[1603756800000,13060.79221208406],[1603843200000,13655.185415883081],[1603929600000,13282.999348292438],[1604016000000,13441.878496031612],[1604102400000,13537.174271524887],[1604188800000,13778.637638352931],[1604275200000,13720.361465146289]]}";//,[1604361600000,13558.361795524168],[1604448000000,13989.976358180447],[1604534400000,14101.716050813722],[1604620800000,15553.331701081443],[1604707200000,15548.312145063144],[1604793600000,14818.45891122149],[1604880000000,15496.316149147417],[1604966400000,15335.342198178862],[1605052800000,15278.70965979927],[1605139200000,15686.905986213233],[1605225600000,16265.149252483357],[1605312000000,16326.81487507908],[1605398400000,16095.561510630652],[1605484800000,15984.673784156614],[1605571200000,16714.40386322188],[1605657600000,17651.82042768171],[1605744000000,17829.934958345126],[1605830400000,17819.75743096837],[1605916800000,18628.813489036198],[1606003200000,18689.528655825852],[1606089600000,18390.61184379203],[1606176000000,18360.693300385865],[1606262400000,19091.524181728702],[1606348800000,18753.288921684914],[1606435200000,17138.029512395206],[1606521600000,17140.27555252362],[1606608000000,17718.972832629497],[1606694400000,18169.95420978285],[1606780800000,19609.52143957559],[1606867200000,18857.417371118165],[1606953600000,19208.398191994624],[1607040000000,19435.20484740911],[1607126400000,18711.226549886927],[1607212800000,19139.111575237486],[1607299200000,19325.55411859109],[1607385600000,19198.806493935343],[1607472000000,18336.514581297808],[1607558400000,18564.986455688137],[1607644800000,18262.058384653155],[1607731200000,18058.027339569555],[1607817600000,18807.09540322016],[1607904000000,19151.13442340493],[1607990400000,19259.97047153096],[1608076800000,19432.362456862407],[1608163200000,21317.66213678684],[1608249600000,22805.65580598891],[1608336000000,23120.57055156752],[1608422400000,23863.85484171969],[1608508800000,23518.31842054723],[1608595200000,22840.991707188354],[1608681600000,23794.79330262859],[1608768000000,23308.12723217715],[1608854400000,23760.287048542956],[1608940800000,24671.107714415415],[1609027200000,26476.130137019492],[1609113600000,26423.22879190229],[1609200000000,27125.384120651503],[1609286400000,27424.538954606684],[1609372800000,28837.28852895899],[1609459200000,29022.41839530417],[1609545600000,29352.12679194895],[1609632000000,32163.824935335215],[1609718400000,33008.226203489285],[1609804800000,31515.575966658354],[1609891200000,34082.20604904424],[1609977600000,36933.520137309126],[1610064000000,39547.08408135567],[1610150400000,40815.96185478254],[1610236800000,40296.5290038294],[1610323200000,38397.895985418174],[1610409600000,35669.90668663349],[1610496000000,33938.33587810088],[1610582400000,37456.00772548642],[1610668800000,39232.74997140346],[1610755200000,36787.52121668496],[1610841600000,36254.713079410845],[1610928000000,35804.263885674685],[1611014400000,36595.4647692826],[1611100800000,36104.86385775514],[1611187200000,35587.489202735545],[1611273600000,30913.695736053804],[1611360000000,32957.908782655926],[1611446400000,32068.08737440817],[1611532800000,32273.51735032927],[1611619200000,32375.320062981456],[1611705600000,32582.10944502123],[1611792000000,30445.52586511351],[1611878400000,33128.34752861149],[1611964800000,34150.81876737221],[1612051200000,34199.51981036302],[1612137600000,33064.78676701507],[1612224000000,33405.99035714327],[1612310400000,35485.98593382442],[1612396800000,37494.71762460426],[1612483200000,36816.50808203406],[1612569600000,38007.83222908396],[1612656000000,39279.41286897885],[1612742400000,38833.34026455532],[1612828800000,46307.57412159395],[1612915200000,46569.56483],[1613001600000,44848.69344950499],[1613088000000,47815.96175554316],[1613174400000,47414.1862550079],[1613260800000,46941.29208582354],[1613347200000,48607.8745224845],[1613433600000,47898.487027633135]]}";
	
	public static class BTCData{
		
		public BTCData() {
			
		}
		/**
		 * 
		 */
		List<List<Double>> prices;

		public List<List<Double>> getPrices() {
			return prices;
		}

		public void setPrices(List<List<Double>> prices) {
			this.prices = prices;
		}
		
	}
	
	@Test
	public void canChainRSITransformToThresholdAlertToCreateIndicator() throws JsonProcessingException {
		
		IndicatorInternalState conf = IndicatorInternalState.builder("rsi-fn-1")
				.put("steps", 14.00)
				.build()
				.bindTo("thresh-alt")
				.builder()
				.put("threshold", 30.00)
				.build()
				.bindTo("rsi-fn-1");
		
		// Kinda annoying but getting better.
		
		assertThat(conf.getState(), hasKey("thresh-alt-threshold"));
		assertThat(conf.getState(), hasKey("rsi-fn-1-steps"));
		
		IndicatorTransform rsiT = RSI.getTransform().withConfig(conf);
		
		IndicatorAlert ia = Threshold.movesBelowThresholdAlert()
				.withConfig(conf.bindTo("thresh-alt"));

	    Indicator ind = (input) -> convertInput
	    								.andThen(bindTo.apply("rsi-fn-1"))
	    								.andThen(rsiT)
	    								.andThen(bindTo.apply("thresh-alt"))
	    								.andThen(ia)
	    								.apply(input);
	    
	    BTCData data = null;
	    //List<Double> mockInputs = Arrays.asList();//  = Arrays.asList(42705.48,32706.48,22705.48,42706.48,42705.48,42706.48,42705.48,42706.48,42705.48,42706.48,42705.48,42706.48,42705.48,42706.48,42705.48,42706.48,42705.48,42706.48,42705.48,42706.48,42705.48,42706.48,42705.48,42706.48,42705.48,42706.48,42705.48,42706.48,42705.48,42706.48,42705.48,42706.48,42705.48,42706.48,42705.48,42706.48,42705.48,42706.48,42705.48,42706.48,42705.48,42706.48,42705.48,42706.48,42705.48,42706.48,42705.48,42706.48,42705.48,42706.48,42705.48,42706.48,42705.48,42706.48,42705.48,42706.48,42705.48,42706.48,42705.48,42706.48,42705.48,42706.48,42705.48,42706.48,42705.48,42706.48,42705.48,42706.48,42705.48,42706.48,42705.48,42706.48,42705.48,42706.48,42705.48,42706.48,42705.48,42706.48,42705.48,42706.48);//42705.48,37215.15,42705.48,37215.15,42705.48,37215.15,42705.48,37215.15,42705.48,37215.15,42705.48,37215.15,42705.48,37215.15,42705.48,37215.15,42705.48,42705.48,37215.15,42705.48,37215.15,42705.48,37215.15,42705.48,37215.15,42705.48,42705.48,37215.15,42705.48,37215.15,42705.48,37215.15,42705.48,37215.15,42705.48,42705.48,37215.15,42705.48,37215.15,42705.48,37215.15,42705.48,37215.15,42705.48,42705.48,37215.15,42705.48,37215.15,42705.48,37215.15,42705.48,37215.15,42705.48,42705.48,37215.15,42705.48,37215.15,42705.48,37215.15,42705.48,37215.15,42705.48,42705.48,37215.15,42705.48,37215.15,42705.48,37215.15,42705.48,37215.15,42705.48,42705.48,37215.15,42705.48,37215.15,42705.48,37215.15,42705.48,37215.15,42705.48,42705.48,37215.15,42705.48,37215.15,42705.48,37215.15,42705.48,37215.15,42705.48,42705.48,37215.15,42705.48,37215.15,42705.48,37215.15,42705.48,37215.15,42705.48,42705.48,37215.15,42705.48,37215.15,42705.48,37215.15,42705.48,37215.15,42705.48,42705.48,37215.15,42705.48,37215.15,42705.48,37215.15,42705.48,37215.15,42705.48,42705.48,37215.15,42705.48,37215.15,42705.48,37215.15,42705.48,37215.15,57259.22, 57259.22, 57259.22, 57259.22, 57259.22, 59002.18, 58217.85, 56039.14, 56823.48, 49503.03, 49851.63, 46888.59,46627.15, 43402.67,42705.48,37215.15, 42705.48,37215.15, 42705.48,37215.15, 42705.48,37215.15, 42705.48,37215.15, 42705.48,37215.15); // 2400.5, 2350.0, 2335.0, 2120.0, 1910.0, 1420.0, 1220.0, 1110.0, 935.0, 843.0, 742.0, 621.0, 542.0, 431.0, 300.0, 200.0,2.0,1.0,1.0, 1.0,1.0, 1.0,1.0, 1.0,1.0, 1.0,1.0, 1.0,1.0, 1.0,1.0, 1.0,1.0, 1.0,1.0,1.0,1.0, 1.0,1.0, 1.0,1.0, 1.0,1.0, 1.0,1.0, 1.0,1.0, 1.0,1.0, 1.0,1.0, 1.0,1.0, 1.0,1.0, 1.0,1.0,1.0,1.0, 1.0,1.0, 1.0,1.0, 1.0,1.0, 1.0,1.0, 1.0,1.0, 1.0,1.0, 1.0,1.0, 1.0,1.0, 1.0,1.0, 1.0,1.0,1.0,1.0, 1.0,1.0, 1.0,2.0 );
		
	    ObjectMapper om2 = new ObjectMapper();
		
		try {
			data = om2.readValue(prices, BTCData.class);
		} catch (JsonProcessingException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
		
		assertThat(data.getPrices().get(0).get(1), equalTo(8720.91950137424));
			
		List<Double> mockInputs = data.getPrices().stream().map(price-> price.get(1)).collect(Collectors.toList());
		LoggerFactory.getLogger(IndicatorFactoryTest.class).info("size of BTC data is " + mockInputs.size());
	    
	    List<Optional<IndicatorEvent>> indicatorEvents = new ArrayList<>();
	    
	    // push all data through the indicator
	    mockInputs.stream()
	    				.map(d-> Tuples.of(0, d, IndicatorInternalState.builder("any").build()))
	    				.reduce((p, n) -> {
	    					
	    					// a bit silly hmmm
	    					Tuple2<Optional<IndicatorEvent>, IndicatorInternalState> alrt = ind.test(Tuples.of(0, n.getT2(),p.getT3()));
	    					indicatorEvents.add(alrt.getT1());
	    					ObjectMapper om = new ObjectMapper();
	    					try {
								LoggerFactory.getLogger(IndicatorFactoryTest.class).info(om.writeValueAsString(alrt.getT2().getState()));
							} catch (JsonProcessingException e) {
								// TODO Auto-generated catch block
								e.printStackTrace();
							}
	    					return Tuples.of(0, n.getT2(),alrt.getT2());
	    					
	    				});
	    	
	    // check produces
	    assertThat(Double.valueOf(indicatorEvents.size()), closeTo(Double.valueOf(mockInputs.size()), 2.00));
	    ObjectMapper om = new ObjectMapper();
	    List<IndicatorEvent> events = indicatorEvents.stream().filter(Optional::isPresent).map(Optional::get).collect(Collectors.toList());
	    LoggerFactory.getLogger(IndicatorFactoryTest.class).info(om.writeValueAsString(events));
		assertThat(events.get(0).getValue(), closeTo(17.0, 1.00));
		
	}
}
